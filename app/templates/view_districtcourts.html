{# app/templates/view_districtcourts.html #}
{% extends "base.html" %}
{% block title %}{{ doc.full_title or doc.title or ("Doc " ~ doc.doc_id) }} - Legal Dashboard{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='tribunals.css') }}">

<style>
  /* Layout / base */
  .ds-layout{display:flex;gap:1rem;align-items:flex-start;margin-top:1rem}
  .ds-aside{position:sticky;top:96px;width:260px;flex:0 0 260px}
  .ds-card{background:#fff;border:1px solid #e5e7eb;border-radius:.5rem;padding:1rem}
  .ds-title{font-weight:600;margin-bottom:.5rem}
  .ds-chip{display:block;width:100%;padding:.5rem .75rem;border-radius:.5rem;border:1px solid #e5e7eb;background:#f9fafb;margin-bottom:.5rem;cursor:pointer;text-align:left}
  .ds-chip[data-active="true"]{outline:1px solid rgba(0,0,0,.05)}
  .ds-controls{display:flex;gap:.5rem;margin-top:.5rem;flex-wrap:wrap}
  .ds-btn{padding:.375rem .625rem;border:1px solid #e5e7eb;border-radius:.5rem;background:#fff;cursor:pointer}
  .ds-btn:hover{background:#f9fafb}
  .ds-main{flex:1 1 auto;min-width:0}
  .ds-focus{outline:2px solid rgba(0,0,0,.35);outline-offset:2px}
  .act-content pre{white-space:pre-wrap;word-break:break-word}
  .ds-prose p{line-height:1.6;margin:0.5rem 0}
  .ds-prose h1,.ds-prose h2,.ds-prose h3{margin:1rem 0 .5rem}
  .highlight-section{outline:2px solid rgba(0,0,0,.45);outline-offset:2px}
  @media (max-width:1024px){.ds-layout{flex-direction:column}.ds-aside{position:static;width:100%;flex:none}}

  .act-content[data-ner="off"] .ner { background: transparent !important; border: none !important; }
  .act-content[data-ner="off"] .ner::after { content: none !important; }

  .ner-muted { background: transparent !important; border: none !important; box-shadow: none !important; }
  .ds-ner-panel { margin-top: .5rem; border-top: 1px dashed #e5e7eb; padding-top: .5rem; max-height: 40vh; overflow: auto; }
  .ds-ner-item { display: flex; align-items: center; gap: .5rem; margin: .25rem 0; }
  .ds-ner-item input { accent-color: #3b82f6; }
  .ds-ner-count { margin-left: auto; font-size: .75rem; color: #6b7280; }
</style>

<div class="container mx-auto px-4 md:px-6 py-10">
  <div class="bg-white p-6 md:p-8 rounded-lg shadow-md">
    <h1 class="text-2xl md:text-3xl font-bold text-gray-900 border-b pb-4 mb-4">
      {{ doc.full_title or doc.title or ("Doc " ~ doc.doc_id) }}
    </h1>

    <div class="text-gray-600 mb-6 text-sm">
      <span class="font-semibold">Year:</span> {{ doc.year }} |
      <span class="font-semibold">Court:</span> {{ doc.category_name }} |
      <span class="font-semibold">Law Type:</span> {{ doc.law_type }}
    </div>

    <div class="act-content ds-prose">
      {{ doc.content | safe }}
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  if (document.querySelector('.ds-layout')) return;
  const contentArea = document.querySelector('.act-content');
  if (!contentArea) return;

  // Remove scripts/styles/linked styles in scraped chunk
  contentArea.querySelectorAll('script,style,link[rel="stylesheet"],noscript').forEach(n => n.remove());

  // If a full page was embedded, pull inner .judgments into contentArea
  (function rescueIfNeeded() {
    if (contentArea.querySelector('[data-structure]')) return;
    const judg = contentArea.querySelector('.judgments') || document.querySelector('.judgments');
    if (!judg) return;
    const frag = document.createDocumentFragment();
    Array.from(judg.childNodes).forEach(n => frag.appendChild(n.cloneNode(true)));
    contentArea.innerHTML = ""; contentArea.appendChild(frag);
  })();

  // Trim chrome: keep only between first and last annotated block
  (function trimToAnnotated() {
    const ann = contentArea.querySelectorAll('[data-structure]');
    if (!ann.length) return;
    let topFirst = ann[0];
    while (topFirst.parentElement && topFirst.parentElement !== contentArea) topFirst = topFirst.parentElement;
    while (topFirst.previousSibling) topFirst.previousSibling.remove();

    let topLast = ann[ann.length - 1];
    while (topLast.parentElement && topLast.parentElement !== contentArea) topLast = topLast.parentElement;
    while (topLast.nextSibling) topLast.nextSibling.remove();

    Array.from(contentArea.children).forEach(el => {
      if (!el.matches('[data-structure]') && !el.querySelector('[data-structure]')) el.remove();
    });
  })();

  if (!contentArea.querySelector('[data-structure]')) return;

  // Build two-column layout
  const parent = contentArea.parentNode;
  const layout = document.createElement('div'); layout.className = 'ds-layout';
  const aside  = document.createElement('aside'); aside.className = 'ds-aside';
  const main   = document.createElement('div'); main.className = 'ds-main';
  parent.insertBefore(layout, contentArea);
  layout.appendChild(aside); layout.appendChild(main); main.appendChild(contentArea);

  const card = document.createElement('div'); card.className = 'ds-card';
  const title = document.createElement('div'); title.className = 'ds-title'; title.textContent = 'Rhetorical Roles';
  const nav = document.createElement('div'); nav.id = 'ds-nav';
  const controls = document.createElement('div'); controls.className = 'ds-controls';
  const clearBtn = document.createElement('button'); clearBtn.className = 'ds-btn'; clearBtn.type = 'button'; clearBtn.textContent = 'Clear';
  controls.appendChild(clearBtn); card.appendChild(title); card.appendChild(nav); card.appendChild(controls); aside.appendChild(card);

  // Collect roles dynamically
  const nodes = Array.from(contentArea.querySelectorAll('[data-structure]'));

  // === Section-aware helpers ===
  const BLOCK_SEL = 'p, blockquote, li, section, article, div, table, ul, ol';
  function blockOf(el){ return el.closest(BLOCK_SEL) || el; }
  function hasMarker(el){ return el.matches?.('[data-structure]') || !!el.querySelector?.('[data-structure]'); }
  function sectionBlocksFor(startEl){
    const startBlock = blockOf(startEl);
    const blocks = [];
    if (!startBlock) return blocks;
    blocks.push(startBlock);
    const it = document.createNodeIterator(contentArea, NodeFilter.SHOW_ELEMENT, {
      acceptNode(node){
        if (node.compareDocumentPosition(startBlock) & Node.DOCUMENT_POSITION_FOLLOWING) return NodeFilter.FILTER_ACCEPT;
        return NodeFilter.FILTER_SKIP;
      }
    });
    let node;
    while ((node = it.nextNode())){
      if (hasMarker(node)) break;
      const blk = node.matches(BLOCK_SEL) ? node : node.closest(BLOCK_SEL);
      if (blk && blk.closest('.act-content') === contentArea){
        if (!blocks.includes(blk) && !blocks.some(b => b.contains(blk)) && !blocks.some(b => blk.contains(b))){
          blocks.push(blk);
        }
      }
    }
    return blocks;
  }

  let byType = Object.create(null), labels = Object.create(null), order = [], chips = new Map();
  nodes.forEach(el => {
    const raw = (el.getAttribute('data-structure') || '').trim();
    if (!raw) return;
    const key = raw.toLowerCase();
    (byType[key] ||= []).push(el);
    if (!(key in labels)) labels[key] = raw;
    if (!order.includes(key)) order.push(key);
  });

  // Dynamic colors
  const PALETTE = [
    'rgba(96,165,250,.18)','rgba(251,191,36,.20)','rgba(167,139,250,.18)',
    'rgba(52,211,153,.18)','rgba(244,114,182,.18)','rgba(248,113,113,.18)',
    'rgba(56,189,248,.18)','rgba(250,204,21,.18)','rgba(163,230,53,.18)','rgba(251,113,133,.18)'
  ];
  const roleColor = {}; order.forEach((k,i) => roleColor[k] = PALETTE[i % PALETTE.length]);
  const active = new Set();

  function on(key, sc){
    const chip = chips.get(key);
    chip.setAttribute('data-active','true');
    chip.style.backgroundColor = roleColor[key];
    chip.style.borderColor = 'rgba(0,0,0,.08)';

    const list = byType[key] || [];
    const blocks = new Set();
    list.forEach(el => sectionBlocksFor(el).forEach(b => blocks.add(b)));
    blocks.forEach(b => {
      b.classList.add('ds-highlight');
      b.style.backgroundColor = roleColor[key];
    });

    if (sc && list.length){
      const firstBlock = blockOf(list[0]);
      if (firstBlock){
        firstBlock.classList.add('ds-focus');
        firstBlock.scrollIntoView({behavior:'smooth', block:'center'});
        setTimeout(()=>firstBlock.classList.remove('ds-focus'),1500);
      }
    }
    active.add(key);
  }

  function off(key){
    const chip = chips.get(key);
    chip.setAttribute('data-active','false');
    chip.style.backgroundColor = '';
    chip.style.borderColor = '';
    const list = byType[key] || [];
    const blocks = new Set();
    list.forEach(el => sectionBlocksFor(el).forEach(b => blocks.add(b)));
    blocks.forEach(b => { b.classList.remove('ds-highlight','ds-focus'); b.style.backgroundColor=''; });
    active.delete(key);
  }

  function toggle(key, sc){ (chips.get(key).getAttribute('data-active') === 'true') ? off(key) : on(key, sc); }
  function clearAll(){ Array.from(active).forEach(k => off(k)); }
  clearBtn.addEventListener('click', clearAll);

  // Render chips
  order.forEach(key => {
    const chip = document.createElement('button');
    chip.className = 'ds-chip';
    chip.type = 'button';
    chip.textContent = labels[key];
    chip.setAttribute('data-active','false');
    chip.addEventListener('click', () => toggle(key, true));
    chips.set(key, chip);
    nav.appendChild(chip);
  });

  // Intercept /doc/<id> links inside judgment and route to districtcourt view
  contentArea.addEventListener('click', function (event) {
    const a = event.target.closest('a'); if (!a) return;
    const raw = a.getAttribute('href') || '', abs = a.href || '';
    const m = (raw.match(/\/doc\/(\d+)/) || abs.match(/\/doc\/(\d+)/));
    if (m && m[1]) { event.preventDefault(); window.location.href = `/districtcourt/view/${m[1]}`; }
  });

  // ?highlight= and ?ds=
  const params = new URLSearchParams(window.location.search);
  const highlightId = params.get('highlight');
  if (highlightId) {
    const target = Array.from(contentArea.querySelectorAll('a[href*="/doc/"]'))
      .find(a => ((a.getAttribute('href')||'') + (a.href||'')).includes(`/doc/${highlightId}`));
    const section = target && (target.closest('[data-structure]') || target.closest('p, div, section, article'));
    if (section) {
      section.scrollIntoView({behavior:'smooth', block:'center'});
      section.classList.add('highlight-section');
      setTimeout(()=>section.classList.remove('highlight-section'), 3000);
    }
  }
  const dsParam = params.get('ds');
  if (dsParam) dsParam.split(',').map(s => s.trim().toLowerCase()).forEach(k => byType[k] && on(k, false));

  // === NER toggle with filter checkboxes ===
  const DOC_ID = "{{ doc.doc_id }}";
  const NER_API = "{{ url_for('districtcourt.api_ner_html', doc_id=doc.doc_id) }}";

  contentArea.setAttribute('data-ner', 'off');
  let RAW_HTML = contentArea.innerHTML;
  let NER_HTML = null;

  let activeLabels = new Set();
  let labelIndex  = new Map();
  let nerPanelBuilt = false;

  const nerChip = document.createElement('button');
  nerChip.className = 'ds-chip';
  nerChip.type = 'button';
  nerChip.textContent = 'NER';
  nerChip.setAttribute('data-active','false');
  nav.appendChild(nerChip);

  const nerPanel = document.createElement('div');
  nerPanel.className = 'ds-ner-panel';
  nerPanel.style.display = 'none';
  nav.appendChild(nerPanel);

  function indexEntities() {
    labelIndex.clear();
    contentArea.querySelectorAll('.ner').forEach(span => {
      const lab = (span.getAttribute('data-entity') || '').toUpperCase();
      if (!lab) return;
      if (!labelIndex.has(lab)) labelIndex.set(lab, []);
      labelIndex.get(lab).push(span);
    });
  }

  function buildNerPanel() {
    nerPanel.innerHTML = '';
    const ctrlRow = document.createElement('div');
    ctrlRow.className = 'ds-controls';
    const allBtn  = document.createElement('button'); allBtn.className = 'ds-btn'; allBtn.textContent = 'All';
    const noneBtn = document.createElement('button'); noneBtn.className = 'ds-btn'; noneBtn.textContent = 'None';
    ctrlRow.appendChild(allBtn); ctrlRow.appendChild(noneBtn);
    nerPanel.appendChild(ctrlRow);

    const entries = Array.from(labelIndex.entries()).sort((a,b) => b[1].length - a[1].length);
    entries.forEach(([label, nodes]) => {
      const row = document.createElement('label');
      row.className = 'ds-ner-item';
      const cb = document.createElement('input');
      cb.type = 'checkbox'; cb.value = label; cb.checked = false;
      const name = document.createElement('span'); name.textContent = label;
      const count = document.createElement('span'); count.className = 'ds-ner-count'; count.textContent = nodes.length;
      row.appendChild(cb); row.appendChild(name); row.appendChild(count);
      nerPanel.appendChild(row);

      cb.addEventListener('change', () => {
        if (cb.checked) activeLabels.add(label); else activeLabels.delete(label);
        applyNerFilter();
      });
    });

    allBtn.addEventListener('click', () => {
      activeLabels = new Set(Array.from(labelIndex.keys()));
      nerPanel.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
      applyNerFilter();
    });
    noneBtn.addEventListener('click', () => {
      activeLabels.clear();
      nerPanel.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
      applyNerFilter();
    });

    nerPanelBuilt = true;
  }

  function applyNerFilter() {
    contentArea.querySelectorAll('.ner').forEach(span => span.classList.add('ner-muted'));
    activeLabels.forEach(label => {
      (labelIndex.get(label) || []).forEach(span => span.classList.remove('ner-muted'));
    });
  }

  function rebuildRoleIndex() {
    const nodesNew = Array.from(contentArea.querySelectorAll('[data-structure]'));
    byType = Object.create(null);
    labels = Object.create(null);
    order.length = 0;
    nodesNew.forEach(el => {
      const raw = (el.getAttribute('data-structure') || '').trim();
      if (!raw) return;
      const key = raw.toLowerCase();
      (byType[key] ||= []).push(el);
      if (!(key in labels)) labels[key] = raw;
      if (!order.includes(key)) order.push(key);
    });
  }

  nerChip.addEventListener('click', async () => {
    const isOn = nerChip.getAttribute('data-active') === 'true';

    if (!isOn) {
      try {
        if (!NER_HTML) {
          nerChip.disabled = true;
          nerChip.textContent = 'NER (loading...)';
          const res = await fetch(NER_API, { headers: { 'Accept': 'application/json' }});
          const data = await res.json();
          if (!res.ok || !data.html) throw new Error(data.error || 'NER API failed');
          NER_HTML = data.html;
        }

        contentArea.innerHTML = NER_HTML;
        contentArea.setAttribute('data-ner', 'on');
        nerChip.setAttribute('data-active','true');

        rebuildRoleIndex();
        indexEntities();

        if (!nerPanelBuilt) buildNerPanel();
        nerPanel.style.display = 'block';

        activeLabels.clear();
        nerPanel.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        applyNerFilter();

        contentArea.addEventListener('click', function (event) {
          const a = event.target.closest('a'); if (!a) return;
          const raw = a.getAttribute('href') || '', abs = a.href || '';
          const m = (raw.match(/\/doc\/(\d+)/) || abs.match(/\/doc\/(\d+)/));
          if (m && m[1]) { event.preventDefault(); window.location.href = `/districtcourt/view/${m[1]}`; }
        });

      } catch (e) {
        console.error('[NER] toggle failed', e);
        alert('Failed to load NER. Check server logs.');
      } finally {
        nerChip.disabled = false;
        nerChip.textContent = 'NER';
      }
    } else {
      contentArea.innerHTML = RAW_HTML;
      contentArea.setAttribute('data-ner', 'off');
      nerChip.setAttribute('data-active','false');
      nerPanel.style.display = 'none';
      rebuildRoleIndex();
    }
  });
});
</script>
{% endblock %}
